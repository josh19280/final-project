name: C Build and Run

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      # 1️ 取得 repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️ 編譯 encoder 和 decoder
      - name: Compile encoder and decoder
        run: |
          gcc -o encoder encoder.c -lm
          gcc -o decoder decoder.c -lm

      # 3️ 執行 encoder method 0
      - name: Run encoder method 0
        run: |
          ./encoder 0 Kimberly.bmp R.txt G.txt B.txt dim.txt

      # 4️ 執行 decoder method 0
      - name: Run decoder method 0
        run: |
          ./decoder 0 ResKimberly.bmp R.txt G.txt B.txt dim.txt

      # 5️ 執行 encoder method 1
      - name: Run encoder method 1
        run: |
          ./encoder 1 Kimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt \
                    qF_Y.raw qF_Cb.raw qF_Cr.raw eF_Y.raw eF_Cb.raw eF_Cr.raw

      # 6️ 執行 decoder method 1(a)
      - name: Run decoder method 1a
        run: |
          ./decoder 1 QResKimberly.bmp Kimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt \
                    dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw

      # 7️ 執行 decoder method 1(b)
      - name: Run decoder method 1b
        run: |
          ./decoder 1 ResKimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt \
                    qF_Y.raw qF_Cb.raw qF_Cr.raw eF_Y.raw eF_Cb.raw eF_Cr.raw

      # 8️ 比對 BMP
      - name: Compare decoded BMP
        run: |
          cmp ResKimberly.bmp Kimberly.bmp || echo "Method 0 decoded BMP differs"
          cmp QResKimberly.bmp Kimberly.bmp || echo "Method 1a decoded BMP differs"
          cmp ResKimberly.bmp Kimberly.bmp || echo "Method 1b decoded BMP differs"

      # 9️ 上傳 artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: decoded-and-encoded-files
          path: |
            ResKimberly.bmp
            QResKimberly.bmp
            Qt_Y.txt
            Qt_Cb.txt
            Qt_Cr.txt
            qF_Y.raw
            qF_Cb.raw
            qF_Cr.raw
            eF_Y.raw
            eF_Cb.raw
            eF_Cr.raw
